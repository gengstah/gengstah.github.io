---
title: 'CVE-2025-62221 - Windows Cloud Files Mini Filter Driver Elevation of Privilege Vulnerability'
date: 2025-12-10
permalink: /posts/2025/12/CVE-2025-62221/
tags:
  - windows
  - 1-day
  - cldflt.sys
  - CVE-2025-62221
  - exploitation
---

The purpose of a file system filter driver according to [Microsoft](https://docs.microsoft.com/en-us/windows-hardware/drivers/ifs/about-file-system-filter-drivers) is:
> "A file system filter driver can filter I/O operations for one or more file systems or file system volumes. Depending on the nature of the driver, filter can mean log, observe, modify, or even prevent. Typical applications for file system filter drivers include antivirus utilities, encryption programs, and hierarchical storage management systems."

# CVE-2025-62221 - Windows Cloud Files Mini Filter Driver Elevation of Privilege Vulnerability
Entrypoint - `HsmDriverEntry`

```c
NTSTATUS FLTAPI FltRegisterFilter(
  [in]  PDRIVER_OBJECT         Driver,
  [in]  const FLT_REGISTRATION *Registration,
  [out] PFLT_FILTER            *RetFilter
);
```

```c
typedef struct _FLT_REGISTRATION {
  USHORT                                      Size;
  USHORT                                      Version;
  FLT_REGISTRATION_FLAGS                      Flags;
  const FLT_CONTEXT_REGISTRATION              *ContextRegistration; // 0x8
  const FLT_OPERATION_REGISTRATION            *OperationRegistration; // 0x10
  PFLT_FILTER_UNLOAD_CALLBACK                 FilterUnloadCallback; // 0x18
  PFLT_INSTANCE_SETUP_CALLBACK                InstanceSetupCallback; // 0x20
  PFLT_INSTANCE_QUERY_TEARDOWN_CALLBACK       InstanceQueryTeardownCallback; // 0x28
  PFLT_INSTANCE_TEARDOWN_CALLBACK             InstanceTeardownStartCallback;
  PFLT_INSTANCE_TEARDOWN_CALLBACK             InstanceTeardownCompleteCallback;
  PFLT_GENERATE_FILE_NAME                     GenerateFileNameCallback;
  PFLT_NORMALIZE_NAME_COMPONENT               NormalizeNameComponentCallback;
  PFLT_NORMALIZE_CONTEXT_CLEANUP              NormalizeContextCleanupCallback;
  PFLT_TRANSACTION_NOTIFICATION_CALLBACK      TransactionNotificationCallback;
  PFLT_NORMALIZE_NAME_COMPONENT_EX            NormalizeNameComponentExCallback;
  PFLT_SECTION_CONFLICT_NOTIFICATION_CALLBACK SectionNotificationCallback;
} FLT_REGISTRATION, *PFLT_REGISTRATION;
```

```c
typedef struct _FLT_OPERATION_REGISTRATION {
  UCHAR                            MajorFunction;
  FLT_OPERATION_REGISTRATION_FLAGS Flags;
  PFLT_PRE_OPERATION_CALLBACK      PreOperation;
  PFLT_POST_OPERATION_CALLBACK     PostOperation;
  PVOID                            Reserved1;
} FLT_OPERATION_REGISTRATION, *PFLT_OPERATION_REGISTRATION;
```

```c
LABEL_16:
    [...snipped...]
      *(_QWORD *)Registration = 0x2030070LL;
      memset(&Registration[48], 0, 64);
      *(_QWORD *)&Registration[0x8] = &g_HsmContextRegistration;
      *(_QWORD *)&Registration[0x10] = &g_HsmFltCallbacks;
      *(_QWORD *)&Registration[0x20] = HsmFltInstanceSetup;
      *(_QWORD *)&Registration[0x18] = HsmFltUnload;
      *(_QWORD *)&Registration[0x28] = HsmFltInstanceQueryTeardown;
      started = (unsigned int)HsmpOpenInstancesRegistryKey(&_BE, &Handle);
      HsmDbgBreakOnStatus(started);
    [...snipped...]
```

Global variable `g_HsmFltCallbacks` which corresponds to `OperationRegistration` of the `FLT_REGISTRATION` and references a list of `FLT_OPERATION_REGISTRATION` structures defining the IO request callbacks. Each entry contains the IRP major code for the operation (such as `IRP_MJ_CREATE` or `IRP_MJ_FILE_SYSTEM_CONTROL`) and can have a pre-request and post-request callback. The driver doesn't need to specify both if it doesn't need both. The list is a variable length array, terminated with the major code being set to `IRP_MJ_OPERATION_END` (0x80).
```
.rdata:00000001C001B000 ; FLT_OPERATION_REGISTRATION g_HsmFltCallbacks
.rdata:00000001C001B000 g_HsmFltCallbacks FLT_OPERATION_REGISTRATION <0FFh, 0, \
.rdata:00000001C001B000                                         ; DATA XREF: HsmDriverEntry+322â†“o
.rdata:00000001C001B000                                             offset HsmFltPreACQUIRE_FOR_SECTION_SYNCHRONIZATION,\
.rdata:00000001C001B000                                             offset HsmFltPostACQUIRE_FOR_SECTION_SYNCHRONIZATION,\
.rdata:00000001C001B000                                             0>
.rdata:00000001C001B020                 FLT_OPERATION_REGISTRATION <12h, 0, offset HsmFltPreCLEANUP, \
.rdata:00000001C001B020                                             offset HsmFltPostCLEANUP, 0>
.rdata:00000001C001B040                 FLT_OPERATION_REGISTRATION <0, 0, offset HsmFltPreCREATE, \
.rdata:00000001C001B040                                             offset HsmFltPostNETWORK_QUERY_OPEN, 0>
.rdata:00000001C001B060                 FLT_OPERATION_REGISTRATION <0Ch, 0, offset HsmFltPreDIRECTORY_CONTROL,\
.rdata:00000001C001B060                                             offset HsmFltPostDIRECTORY_CONTROL, 0>
.rdata:00000001C001B080                 FLT_OPERATION_REGISTRATION <0F3h, 0, \
.rdata:00000001C001B080                                             offset HsmFltPreFAST_IO_CHECK_IF_POSSIBLE,\
.rdata:00000001C001B080                                             0, 0>
.rdata:00000001C001B0A0                 FLT_OPERATION_REGISTRATION <0Dh, 0, \
.rdata:00000001C001B0A0                                             offset HsmFltPreFILE_SYSTEM_CONTROL, \
.rdata:00000001C001B0A0                                             offset HsmFltPostFILE_SYSTEM_CONTROL, 0>
.rdata:00000001C001B0C0                 FLT_OPERATION_REGISTRATION <11h, 0, offset HsmFltPreLOCK_CONTROL, \
.rdata:00000001C001B0C0                                             offset HsmFltPostLOCK_CONTROL, 0>
.rdata:00000001C001B0E0                 FLT_OPERATION_REGISTRATION <0F1h, 0, offset HsmFltPreMDL_READ, 0, 0>
.rdata:00000001C001B100                 FLT_OPERATION_REGISTRATION <0F2h, 0, \
.rdata:00000001C001B100                                             offset HsmFltPreNETWORK_QUERY_OPEN, \
.rdata:00000001C001B100                                             offset HsmFltPostNETWORK_QUERY_OPEN, 0>
.rdata:00000001C001B120                 FLT_OPERATION_REGISTRATION <0EFh, 0, \
.rdata:00000001C001B120                                             offset HsmFltPrePREPARE_MDL_WRITE, 0, 0>
.rdata:00000001C001B140                 FLT_OPERATION_REGISTRATION <3, 0, offset HsmFltPreREAD, \
.rdata:00000001C001B140                                             offset HsmFltPostACQUIRE_FOR_SECTION_SYNCHRONIZATION,\
.rdata:00000001C001B140                                             0>
.rdata:00000001C001B160                 FLT_OPERATION_REGISTRATION <6, 0, offset HsmFltPreSET_INFORMATION, \
.rdata:00000001C001B160                                             offset HsmFltPostSET_INFORMATION, 0>
.rdata:00000001C001B180                 FLT_OPERATION_REGISTRATION <8, 0, offset HsmFltPreSET_EA, 0, 0>
.rdata:00000001C001B1A0                 FLT_OPERATION_REGISTRATION <4, 0, offset HsmFltPreWRITE, \
.rdata:00000001C001B1A0                                             offset HsmFltPostACQUIRE_FOR_SECTION_SYNCHRONIZATION,\
.rdata:00000001C001B1A0                                             0>
.rdata:00000001C001B1C0                 FLT_OPERATION_REGISTRATION <5, 0, 0, \
.rdata:00000001C001B1C0                                             offset HsmFltPostQUERY_INFORMATION, 0>
.rdata:00000001C001B1E0                 FLT_OPERATION_REGISTRATION <0F9h, 0, offset HsmFltPreQUERY_OPEN, \
.rdata:00000001C001B1E0                                             offset HsmFltPostQUERY_OPEN, 0>
.rdata:00000001C001B200                 FLT_OPERATION_REGISTRATION <80h, 0, 0, 0, 0>
```



## Reaching the vulnerable code

HsmFltPreFILE_SYSTEM_CONTROL > HsmFltProcessHSMControl > HsmFltProcessLockProperties / HsmFltProcessUnlockProperties > HsmiProcessPropertyLockRequestList > HsmiGrantLockRequest

The `HsmFltPreFILE_SYSTEM_CONTROL` callback is declared to filter requests with MajorFunction of `0xD` which corresponds to `IRP_MJ_FILE_SYSTEM_CONTROL`, as shown below.

IRP Major Functions List
```c
#define IRP_MJ_CREATE                   0x00
#define IRP_MJ_CREATE_NAMED_PIPE        0x01
#define IRP_MJ_CLOSE                    0x02
#define IRP_MJ_READ                     0x03
#define IRP_MJ_WRITE                    0x04
#define IRP_MJ_QUERY_INFORMATION        0x05
#define IRP_MJ_SET_INFORMATION          0x06
#define IRP_MJ_QUERY_EA                 0x07
#define IRP_MJ_SET_EA                   0x08
#define IRP_MJ_FLUSH_BUFFERS            0x09
#define IRP_MJ_QUERY_VOLUME_INFORMATION 0x0a
#define IRP_MJ_SET_VOLUME_INFORMATION   0x0b
#define IRP_MJ_DIRECTORY_CONTROL        0x0c
#define IRP_MJ_FILE_SYSTEM_CONTROL      0x0d
#define IRP_MJ_DEVICE_CONTROL           0x0e
#define IRP_MJ_INTERNAL_DEVICE_CONTROL  0x0f
#define IRP_MJ_SHUTDOWN                 0x10
#define IRP_MJ_LOCK_CONTROL             0x11
#define IRP_MJ_CLEANUP                  0x12
#define IRP_MJ_CREATE_MAILSLOT          0x13
#define IRP_MJ_QUERY_SECURITY           0x14
#define IRP_MJ_SET_SECURITY             0x15
#define IRP_MJ_POWER                    0x16
#define IRP_MJ_SYSTEM_CONTROL           0x17
#define IRP_MJ_DEVICE_CHANGE            0x18
#define IRP_MJ_QUERY_QUOTA              0x19
#define IRP_MJ_SET_QUOTA                0x1a
#define IRP_MJ_PNP                      0x1b
#define IRP_MJ_PNP_POWER                IRP_MJ_PNP      // Obsolete....
#define IRP_MJ_MAXIMUM_FUNCTION         0x1b
```

```c
PFLT_PRE_OPERATION_CALLBACK PfltPreOperationCallback;

FLT_PREOP_CALLBACK_STATUS PfltPreOperationCallback(
  [in, out] PFLT_CALLBACK_DATA Data,
  [in]      PCFLT_RELATED_OBJECTS FltObjects,
  [out]     PVOID *CompletionContext
)
{...}
```

```c
typedef struct _FLT_CALLBACK_DATA {
  FLT_CALLBACK_DATA_FLAGS     Flags;
  PETHREAD                    Thread;
  PFLT_IO_PARAMETER_BLOCK     Iopb;
  IO_STATUS_BLOCK             IoStatus;
  struct _FLT_TAG_DATA_BUFFER *TagData;
  union {
    struct {
      LIST_ENTRY QueueLinks;
      PVOID      QueueContext[2];
    };
    PVOID FilterContext[4];
  };
  KPROCESSOR_MODE             RequestorMode;
} FLT_CALLBACK_DATA, *PFLT_CALLBACK_DATA;
```

```c
typedef struct _FLT_RELATED_OBJECTS {
  USHORT        Size;
  USHORT        TransactionContext;
  PFLT_FILTER   Filter;
  PFLT_VOLUME   Volume;
  PFLT_INSTANCE Instance;
  PFILE_OBJECT  FileObject;
  PKTRANSACTION Transaction;
} FLT_RELATED_OBJECTS, *PFLT_RELATED_OBJECTS;
```

```c
typedef struct _FLT_IO_PARAMETER_BLOCK {
  ULONG          IrpFlags;
  UCHAR          MajorFunction;
  UCHAR          MinorFunction;
  UCHAR          OperationFlags;
  UCHAR          Reserved;
  PFILE_OBJECT   TargetFileObject;
  PFLT_INSTANCE  TargetInstance;
  FLT_PARAMETERS Parameters;
} FLT_IO_PARAMETER_BLOCK, *PFLT_IO_PARAMETER_BLOCK;
```

```c
Iopb2 = CallbackData->Iopb;
Parameters = Iopb2->Parameters.CreatePipe.Parameters;
[...snipped...]
Iopb3 = CallbackData->Iopb;
param_1 = Parameters[1];
[...snipped...]
switch ( param_1 )
{
  case 0xC0000001:
    v90 = 1;
    Placeholders = (unsigned int)HsmiOpPrepareOperation(
                                    CallbackData,
                                    (__int64)StreamHandleContext,
                                    (__int64)resource,
                                    (unsigned __int8)&OwnerTable2,
                                    648,
                                    (__int64)&v74);
    HsmDbgBreakOnStatus(Placeholders);
    if ( (int)Placeholders >= 0 )
    {
      Placeholders = (unsigned int)HsmFltProcessCreatePlaceholders(
                                      pdevice_object_wpp_global_control,
                                      InstanceContext,
                                      *(_QWORD *)Iopb_TargetFileObject);
      HsmDbgBreakOnStatus(Placeholders);
    }
    break;
  [...snipped...]
  case 0xC0000021:
    v90 = 0;
    Placeholders = (unsigned int)HsmiOpPrepareOperation(
                                    CallbackData,
                                    (__int64)StreamHandleContext,
                                    (__int64)resource,
                                    (unsigned __int8)&OwnerTable2,
                                    0x180,
                                    (__int64)&v74);
    HsmDbgBreakOnStatus(Placeholders);
    if ( (int)Placeholders >= 0 )
    {
      params = Parameters;
      v26 = OwnerThread;
      Placeholders = (unsigned int)HsmFltProcessLockProperties(
                                      pdevice_object_wpp_global_control,
                                      InstanceContext,
                                      *(PFILE_OBJECT *)Iopb_TargetFileObject,
                                      StreamHandleContext,
                                      resource,
                                      OwnerTable2,
                                      OwnerThread,
                                      CallbackData,
                                      params,
                                      parameters_create_options,
                                      Size);
      HsmDbgBreakOnStatus(Placeholders);
      goto LABEL_201;
    }
    break;
}
```


## References
- https://googleprojectzero.blogspot.com/2021/01/hunting-for-bugs-in-windows-mini-filter.html
- https://www.zerodayinitiative.com/blog/2025/12/9/the-december-2025-security-update-review
